<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
        .carousel-inner > .item {
            position: relative;
            -webkit-transition: 0.2s ease-in-out left;
            -moz-transition: 0.2s ease-in-out left;
            -o-transition: 0.2s ease-in-out left;
            transition: 0.2s ease-in-out left;
        }

        #catalog, #pageSelect {
            padding: 5px;
        }
    </style>
</head>
<body>
<div class="container" id="container">
    <div id="catalog">
    </div>
    <div id="viewer">
        <div id="pageSelect"></div>
        <ul class="pager">
            <li class="previous"><a href="#">上一页</a></li>
            <li class="next"><a href="#">下一页</a></li>
        </ul>
        <img src="" class="img-responsive center-block"/>
    </div>
</div>
<!-- <script src="//cdn.bootcss.com/json2/20160511/json2.js"></script> -->
<script src="//cdn.bootcss.com/jquery/1.12.4/jquery.js"></script>
<script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.js"></script>
<script src="//cdn.bootcss.com/eruda/1.2.2/eruda.js"></script>
<script>eruda.init();</script>
<script type="text/javascript">
    (function () {
        var IMAGE_HOST = "http://p.yogajx.com";
        var chapters;
        var chapterMap = {};
        var $viewer = $("#viewer");
        var $catalog = $("#catalog");
        var $pageSelect = $("#pageSelect");

        function loadData() {
            $.ajax({
                url: "input.json",
                type: "get",
                dataType: "text",
                success: function (data) {
                    chapters = getChapters(data);
                    for (var i = 0, len = chapters.length; i < len; i++) {
                        var chapter = chapters[i];
                        chapterMap[chapter.cid] = chapter;
                    }
                },
                async: false
            });
        }

        function getChapters(data) {
            var chapters = [];
            var chapterJsonArr = data.split("\n");
            for (var i = 0, len = chapterJsonArr.length; i < len; i++) {
                var chapter = JSON.parse(chapterJsonArr[i]);
                chapters.push(chapter);
            }
            return chapters;
        }

        function generateViewer(cid, page) {
            var chapter = chapterMap[cid];
            var pathPrefix = IMAGE_HOST + chapter.path;
            var files = chapter["files"];
            if (page < 0) {
                page = 0;
            } else if (page > files.length) {
                page = files.length
            }
            var fileName = files[page];
            var idx = fileName.lastIndexOf(".webp");
            if (idx > 0) {
                fileName = fileName.substring(0, fileName.lastIndexOf(".webp"));
            }
            var fullPath = pathPrefix + fileName;
            $viewer.find("img").attr("src", fullPath);
        }

        function generateCatalog(chapters) {
            var select = $('<select class="form-control"></select>');
            for (var i = 0, len = chapters.length; i < len; i++) {
                var chapter = chapters[i];
                var chapterName = chapter.bname + "" + chapter.cname;
                var selected = i == 0 ? ' selected="selected"' : '';
                var option = $('<option value="' + chapter.cid + '"' + selected + '>' + chapterName + '</option>')
                $(select).append(option);
            }
            return $(select);
        }

        function generatePageSelect(totalPage) {
            var select = $('<select class="form-control"></select>');
            for (var i = 0; i < totalPage; i++) {
                var text = "第" + (i + 1) + "页";
                var option = $('<option value="' + i + '">' + text + '</option>');
                $(select).append(option);
            }
            return $(select);
        }

        window.IKanman = {
            page: 0,
            chapter: 0,
            totalPage: 0,
            init: function () {
                loadData();
                this.initCatalog();
                this.changeChapter($catalog.find("select").val());
            },
            initCatalog: function () {
                var $select = generateCatalog(chapters);
                var self = this;
                $select.on("change", function () {
                    self.changeChapter($(this).val());
                });
                $catalog.html($select);
            },
            changeChapter: function (cid) {
                var self = this;
                this.chapter = cid;
                this.page = 0;
                var files = chapterMap[this.chapter]["files"];
                this.totalPage = files.length;
                var pageSelect = generatePageSelect(this.totalPage);
                pageSelect.on("change", function () {
                    self.gotoPage($(this).val());
                });
                $pageSelect.html(pageSelect);
                this.gotoPage(this.page);
            },
            gotoPage: function (page) {
                if (page < 0) {
                    return false;
                }
                if (page > this.totalPage - 1) {
                    return false;
                }
                var self = this;
                this.page = page;
                generateViewer(this.chapter, this.page);
                $viewer.find(".previous").on("click", function () {
                    self.gotoPage(self.page - 1);
                });
                $viewer.find(".next").on("click", function () {
                    self.gotoPage(self.page + 1);
                });
                $pageSelect.val(this.page);
            },
            printCatalog: function () {
                console.log(chapters);
            }
        };
    })();
    $(function () {
        window.IKanman.init();
    });
</script>
</body>
</html>