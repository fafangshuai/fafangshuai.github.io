<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
        .carousel-inner > .item {
            position: relative;
            -webkit-transition: 0.2s ease-in-out left;
            -moz-transition: 0.2s ease-in-out left;
            -o-transition: 0.2s ease-in-out left;
            transition: 0.2s ease-in-out left;
        }
    </style>
</head>
<body>
<div class="container" id="container">
    <div id="catalog">
    </div>
    <div id="viewer">
    </div>
</div>
<template id="carousel-control-tpl">
    <div id="viewer-carousel" class="carousel slide">
        <div class="carousel-inner">
        </div>
        <a class="carousel-control left" href="#viewer-carousel"
           data-slide="prev"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
            <span class="sr-only">Previous</span></a>
        <a class="carousel-control right" href="#viewer-carousel"
           data-slide="next"><span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
            <span class="sr-only">Next</span></a>
    </div>
</template>
<!-- <script src="//cdn.bootcss.com/json2/20160511/json2.js"></script> -->
<script src="//cdn.bootcss.com/jquery/1.12.4/jquery.js"></script>
<script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.js"></script>
<script type="text/javascript">
    (function () {
        var IMAGE_HOST = "http://p.yogajx.com";
        var chapters;
        var chapterMap = {};
        var $viewer = $("#viewer");
        var $catalog = $("#catalog");

        function loadData() {
            $.ajax({
                url: "input.json",
                type: "get",
                dataType: "text",
                success: function (data) {
                    chapters = getChapters(data);
                    for (var i = 0, len = chapters.length; i < len; i++) {
                        var chapter = chapters[i];
                        chapterMap[chapter.cid] = chapter;
                    }
                },
                async: false
            });
        }

        function getChapters(data) {
            var chapters = [];
            var chapterJsonArr = data.split("\n");
            for (var i = 0, len = chapterJsonArr.length; i < len; i++) {
                var chapter = JSON.parse(chapterJsonArr[i]);
                chapters.push(chapter);
            }
            return chapters;
        }

        function generateViewer(chapter) {
            var viewer = $($("#carousel-control-tpl")[0].innerHTML).clone();
            var imageContainer = viewer.find(".carousel-inner");
            var pathPrefix = IMAGE_HOST + chapter.path;
            for (var i = 0, len = chapter.files.length; i < len; i++) {
                var fileName = chapter.files[i];
                // var idx = fileName.lastIndexOf(".webp");
                // if (idx > 0) {
                    // fileName = fileName.substring(0, fileName.lastIndexOf(".webp"));
                // }
                var fullPath = pathPrefix + fileName;
                var imageDiv = $('<div class="item' + (i == 0 ? " active" : "") + '"> <img src="' + fullPath + '"></div>');
                imageContainer.append(imageDiv);
            }
            return viewer;
        }

        function generateCatalog(chapters) {
            var select = $('<select class="form-control"></select>');
            for (var i = 0, len = chapters.length; i < len; i++) {
                var chapter = chapters[i];
                var chapterName = chapter.bname + "" + chapter.cname;
                var selected = i == 0 ? ' selected="selected"' : '';
                var option = $('<option value="' + chapter.cid + '"' + selected + '>' + chapterName + '</option>')
                $(select).append(option);
            }
            return $(select);
        }

        window.IKanman = {
            init: function () {
                loadData();
                this.initCatalog();
                this.changeChapter($catalog.find("select").val())
            },
            initCatalog: function () {
                var $select = generateCatalog(chapters);
                var self = this;
                $select.on("change", function () {
                    self.changeChapter($(this).val());
                });
                $catalog.html($select);
            },
            changeChapter: function (cid) {
                $viewer.html(generateViewer(chapterMap[cid]));
            },
            printCatalog: function () {
                console.log(chapters);
            }
        };
    })();
    $(function () {
        window.IKanman.init();
    });
</script>
</body>
</html>