<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
        .carousel-inner > .item {
            position: relative;
            -webkit-transition: 0.2s ease-in-out left;
            -moz-transition: 0.2s ease-in-out left;
            -o-transition: 0.2s ease-in-out left;
            transition: 0.2s ease-in-out left;
        }

        #catalog, #pageSelect {
            padding: 5px;
        }
    </style>
</head>
<body>
<div class="container" id="container">
    <div id="catalog">
    </div>
    <div id="viewer">
        <div id="pageSelect">
            <select class="form-control"></select>
        </div>
        <ul class="pager">
            <li class="previous"><a href="#">上一页</a></li>
            <li class="next"><a href="#">下一页</a></li>
        </ul>
        <img src="" class="img-responsive center-block" style="display: none;"/>
        <ul class="pager">
            <li class="previous"><a href="#">上一页</a></li>
            <li class="next"><a href="#">下一页</a></li>
        </ul>
    </div>
</div>
<!-- <script src="//cdn.bootcss.com/json2/20160511/json2.js"></script> -->
<script src="//cdn.bootcss.com/jquery/1.12.4/jquery.js"></script>
<script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.js"></script>
<script src="//cdn.bootcss.com/js-cookie/2.1.3/js.cookie.js"></script>
<script src="//cdn.bootcss.com/eruda/1.2.2/eruda.js"></script>
<script>eruda.init();</script>
<script type="text/javascript">
    (function () {
        var IMAGE_HOST = "http://p.yogajx.com";
        var chapters;
        var chapterMap = {};
        var $viewer = $("#viewer");
        var $catalog = $("#catalog");
        var $pageSelect = $("#pageSelect").find("select");

        function loadData() {
            $.ajax({
                url: "input.json",
                type: "get",
                dataType: "text",
                success: function (data) {
                    chapters = getChapters(data);
                    for (var i = 0, len = chapters.length; i < len; i++) {
                        var chapter = chapters[i];
                        chapterMap[chapter.cid] = chapter;
                    }
                },
                async: false
            });
        }

        function getChapters(data) {
            var chapters = [];
            var chapterJsonArr = data.split("\n");
            for (var i = 0, len = chapterJsonArr.length; i < len; i++) {
                var chapter = JSON.parse(chapterJsonArr[i]);
                chapters.push(chapter);
            }
            return chapters;
        }

        function generateViewer(cid, page) {
            var chapter = chapterMap[cid];
            var pathPrefix = IMAGE_HOST + chapter.path;
            var files = chapter["files"];
            if (page < 0) {
                page = 0;
            } else if (page > files.length) {
                page = files.length
            }
            var fileName = files[page];
            var idx = fileName.lastIndexOf(".webp");
            if (idx > 0) {
                fileName = fileName.substring(0, fileName.lastIndexOf(".webp"));
            }
            var fullPath = pathPrefix + fileName;
            $viewer.find("img").attr("src", fullPath);
        }

        function generateCatalog(chapters) {
            var select = $('<select class="form-control"></select>');
            for (var i = 0, len = chapters.length; i < len; i++) {
                var chapter = chapters[i];
                var chapterName = chapter.bname + "" + chapter.cname;
                var selected = i == 0 ? ' selected="selected"' : '';
                var option = $('<option value="' + chapter.cid + '"' + selected + '>' + chapterName + '</option>')
                $(select).append(option);
            }
            return $(select);
        }

        function generatePageSelect(totalPage) {
            var opts = "";
            for (var i = 0; i < totalPage; i++) {
                var text = "第" + (i + 1) + "页";
                opts += '<option value="' + i + '">' + text + '</option>';
            }
            return $(opts);
        }

        var CookieUtil = {
            options: {expires: 365, path: "/"},
            setCid: function (cid) {
                Cookies.set("cid", cid, this.options);
            },
            setPage: function (page) {
                Cookies.set("page", page, this.options);
            },
            getCid: function () {
                return Cookies.get("cid");
            },
            getPage: function () {
                return Cookies.get("page");
            },
            remove: function (key) {
                Cookies.reomve(key);
            }
        };

        window.IKanman = {
            page: 0,
            chapter: 0,
            totalPage: 0,
            init: function () {
                loadData();
                this.bindEvent();
                this.initCatalog();
                var targetCid;
                if (CookieUtil.getCid()) {
                    targetCid = CookieUtil.getCid();
                    $catalog.find("select").val(targetCid);
                } else {
                    targetCid = $catalog.find("select").val();
                }
                this.changeChapter(targetCid);
                var lastPage = CookieUtil.getPage();
                if (lastPage) {
                    $pageSelect.val(lastPage);
                    this.gotoPage(lastPage);
                }
            },
            initCatalog: function () {
                var $select = generateCatalog(chapters);
                var self = this;
                $select.on("change", function () {
                    self.changeChapter($(this).val());
                    self.gotoPage(0);
                });
                $catalog.html($select);
            },
            changeChapter: function (cid) {
                this.chapter = cid;
                var files = chapterMap[this.chapter]["files"];
                this.totalPage = files.length;
                $pageSelect.html(generatePageSelect(this.totalPage));
                CookieUtil.setCid(this.chapter);
            },
            bindEvent: function () {
                var self = this;
                $pageSelect.on("change", function() {
                    self.gotoPage($(this).val());
                });
                $viewer.find(".previous").on("click", function () {
                    self.pageByBtn(self.page, "prev");
                });
                $viewer.find(".next").on("click", function () {
                    self.pageByBtn(self.page, "next");
                });
            },
            pageByBtn: function (page, direction) {
                if (direction == "next") {
                    if (page > self.totalPage - 1) {
                        page = self.totalPage - 1;
                    } else {
                        page = page + 1;
                    }
                } else if (direction == "prev") {
                    if (page - 1 < 0) {
                        page = 0;
                    } else {
                        page = page - 1;
                    }
                }
                $pageSelect.val(page);
                this.gotoPage(page);
            },
            gotoPage: function (page) {
                this.page = page * 1;
                generateViewer(this.chapter, page);
                CookieUtil.setPage(this.page);
            },
            printCatalog: function () {
                console.log(chapters);
            }
        };
    })();
    $(function () {
        window.IKanman.init();
    });
</script>
</body>
</html>